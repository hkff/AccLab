// Loading aal libs
LOAD "core.types"
LOAD "core.macros"


//=====================================================//
//================ Defining data types ================//
//=====================================================//
TYPE sensitive EXTENDS(data)
TYPE public EXTENDS(data)

/*
 * Username
 * The username used as user credentials, along with the password, to log in to the Wearable Service
 * Sensitive PII
 */
TYPE username EXTENDS(sensitive)

/*
<xacml:Resource>
    <xacml:ResourceMatch
        MatchId="urn:oasis:names:tc:xacml:1.0:function:string-equal">
        <xacml:AttributeValue DataType="http://www.w3.org/2001/XMLSchema#string">username</xacml:AttributeValue>
        <xacml:ResourceAttributeDesignator
            DataType="http://www.w3.org/2001/XMLSchema#string" AttributeId="resource:resource-type" />
    </xacml:ResourceMatch>
</xacml:Resource>
*/

/*
 * Password
 * The password used as user credentials, along with the username, to log in to the Wearable Service
 * Sensitive PII
 */
TYPE password EXTENDS(sensitive)

/*
 * User ID
 * The unique identification number assigned to the user in order to accomplish user specific actions within a session life time
 * Sensitive PII
 */
TYPE userId EXTENDS(sensitive)

/*
 * Display Name
 * The nickname selected by the user to display on the Wearable Service front end, as a comprehensive user reference
 * Public PII
 */
TYPE displayName EXTENDS(public)

/*
 * Gender
 * The gender of the user to be used for determining the threshold values applied to the collected wellbeing metric values.
 *  Gender is considered to affect the optimal values determining the threshold values.
 * Public PII
 */
TYPE gender EXTENDS(public)

/*
 * Age
 * The age of the user to be used for determining the threshold values applied to the collected wellbeing metric values.
 *  Different age groups are considered to have different optimal values determining the threshold values.
 * Public PII
 */
TYPE age EXTENDS(public)

/*
 * Height
 * The height of the user to be used for determining wellbeing related information by joining up the wellbeing record with the body type.
 * Sensitive PII
 */
TYPE height EXTENDS(sensitive)

/*
 * Weight
 * The weight of the user to be used for determining wellbeing related information by joining up the wellbeing record with the body type.
 * Sensitive PII
 */
TYPE weight EXTENDS(sensitive)

/*
 * Sugar Level
 * The sugar level in the user’s blood, measured by the wearable device
 * Sensitive PII
 */
TYPE sugarLevel EXTENDS(sensitive)

/*
 * Blood Pressure
 * The user’s blood pressure, measured by the wearable device
 * Sensitive PII
 */
TYPE blood EXTENDS(sensitive)

/*
 * Heartbeat Rate
 * The user’s heart beat rate, measured by the wearable device
 * Sensitive PII
 */
TYPE heartbeat EXTENDS(sensitive)

/*
 * Training Activity
 * The daily exercises taken by the user, such as time of walking, running, swimming and any other physical exercise
 * Sensitive PII
 */
TYPE activity EXTENDS(sensitive)

/*
 * Wellbeing Score
 * The value of the wellbeing score, based on the formula defined by the cloud service
 * Sensitive PII
 */
TYPE wellbeing EXTENDS(sensitive)

/*
 * Country
 * The country of permanent residence of the user
 * Public PII
 */
TYPE country EXTENDS(public)


//=====================================================//
//================= Defining services =================//
//=====================================================//


/*
 * F1 : Create Customer Profile
 * Create a customer account to the Wearable Service, by determining the credentials for logging into the service and
 *  providing profile data to be processed by the service
 * Used by Wearable Customer
 */
SERVICE createCustomerProfile

/*
 * F2 : Create Business User Profile
 * Create an account for managing the users registered to the Wearable Service and retrieving information about their
 *  public data submitted to the service
 * Used by Wearable Co employee
 */
SERVICE createBusinessProfile

/*
 * F3 : Log in
 * Provide the security mechanism for the user authentication to the service
 * Used by Wearable Customer / Wearable Co employee
 */
SERVICE login

/*
 * F4 : Manage Profile
 * Add / edit / update / delete profile information
 * Used by  Wearable Customer / Wearable Co employee
 */
 SERVICE add
 SERVICE edit
 SERVICE update
 SERVICE delete

/*
 * F5 : Submit Real-time Information
 * Upload data stream with the recorded wellbeing information per time unit (e.g. per hour or per day) as collected by
 *  wearable device. Such data involve the heart beat rate, the blood pressure, the sugar blood level, etc. These data
 *  are associated with the current geographical position of the user.
 * Used by Wearable Customer
 */
SERVICE submitRTI

/*
 * F6 : Request Real- time Information
 * Retrieve a timeline visualisation of the wellbeing collected records, along with the typical threshold values for
 *  the wellbeing metrics per age group and country (for the specific customer)
 * Used by Wearable Customer
 */
SERVICE requestRTI

/*
 * F7 : Update Wellbeing activities
 * Specify everyday activities (such as the duration of a running / walking exercise, etc.)
 * Used by Wearable Customer
 */
SERVICE updateWellbeing

/*
 * F8 : Get wellbeing training
 * Receive recommendations on the available wellbeing training courses
 * Used by Wearable Customer
 */
SERVICE getWellbeingTraining

/*
 * F9 : Get wellbeing score
 * Receive a single value wellbeing score by combining information from the collected real time information and
 *  wellbeing training activities.
 * Used by Wearable Customer
 */
SERVICE getWellbeingScore

/*
 * F10 : Manage Business Formula for wellbeing scores
 * Define the thresholds (per real time data stream, e.g. blood pressure, per age and country) and the weights,
 *  through which the wellbeing score of a customer is determined
 * Used by Wearable Co employee
 */
SERVICE manageBusinessFormula

/*
 * F11 : Update Thresholds
 * Update the threshold for the acceptable values of the wellbeing metrics, possibly customised to geographical
 *  locations (affected by climate and altitude factors)
 * Used by Wearable Co employee
 */
SERVICE updateThresholds

/*
 * F12 : View active users
 * Browse through the list of registered users and part of their profile data
 * Used by Wearable Co employee
 */
SERVICE viewActiveUsers

/*
 * F13 : Request Statistical Visualisation
 * Get a map visualisation of the anonymised wellbeing record data (i.e. blood pressure, accountability score, etc.)
 *  per country and age group
 * Used by Wearable Customer / Wearable Co employee
 */
SERVICE requestStat

/*
 * F14 : Request data handling compliance
 * Get an audit report on how data involved in the Wearable Service are handled in the cloud, by presenting relevant
 *  evidences, such as access logs and listing access violations (if any)
 * Used by Wearable Co employee
 */
SERVICE requestDataCompliance

/*
 * F15 : Request data disclosure path
 * Get a summary of the personal data that the Wearable Service is processing for the specific Wearable Customer
 * Used by Wearable Customer
 */
SERVICE requestDataPath

/*
 * F16 : Receive alerts on excessive wellbeing values
 * In cases of human body metrics getting exceptional (beyond thresholds) values, raise notifications to the referred user
 * Used by Wearable Customer
 */
SERVICE receiveAlerts

/*
 * F17 : Receive policy violation alert
 * Receive a notification on the type of policy violation and detailed information about it
 * Used by Wearable Customer / Wearable Co employee
 */
SERVICE receivePVA
/*
 * F18 : Receive transfer violation alert
 * Receive a notification on the detailed data transfer violation
 * Used by Wearable Customer / Wearable Co employee
 */
SERVICE receiveTVA

/*
 * F19 : Receive breach notification
 * Receive security and/or privacy breach notifications
 * Used by Wearable Customer / Wearable Co employee
 */
SERVICE receiveBreachNotif

//=====================================================//
//================== Defining actors ==================//
//=====================================================//

/*
 * Wearable Customer
 * The end user of the Wearable Service
 * Individual Cloud Subject
 * Data Subject
 */
AGENT customer TYPES(DataSubject)
    REQUIRED(createCustomerProfile  login  add  edit  update  delete  submitRTI
             requestRTI  updateWellbeing  getWellbeingTraining  getWellbeingScore
             requestStat  requestDataPath  receiveAlerts  receivePVA  receiveBreachNotif)
    PROVIDED()

/*
 * Wearable Co
 * The SME operating the Wearable Service
 * Organisational Cloud Customer
 * Data Controller
 */
AGENT wearableCo TYPES(DataController)
    REQUIRED(createBusinessProfile  login  add  edit  update  delete  manageBusinessFormula
             updateThresholds  viewActiveUsers  requestStat  requestDataCompliance  receivePVA
             receiveBreachNotif)
    PROVIDED()

/*
 * CardioMon
 * A SaaS SME cloud provider offering the Wearable Service
 * Cloud Provider
 * Data Processor
 */
AGENT cardioMon TYPES(DataProcessor)
    REQUIRED()
    PROVIDED(createCustomerProfile  login  add  edit  update  delete  submitRTI  requestRTI  updateWellbeing
             getWellbeingTraining  getWellbeingScore  requestStat  requestDataPath  receiveAlerts  receivePVA
             receiveBreachNotif  createBusinessProfile manageBusinessFormula updateThresholds  viewActiveUsers
             requestDataCompliance)

/*
 * Map-on-Web
 * A SaaS cloud provider allowing the creation of maps overlaid with annotated itineraries, based on annotated GPX traces
 * Cloud Provider
 * Data Processor
 */
AGENT mapOnWeb TYPES(DataProcessor)
    REQUIRED()
    PROVIDED()

/*
 * DataSpacer
 * An IaaS cloud provider operating an OpenStack-based cloud environment for processing and hosting different types of data
 * Cloud Provider
 * Data Processor
 */
AGENT dataSpacer TYPES(DataProcessor)
    REQUIRED()
    PROVIDED()


// wearableCo employee type
TYPE WCOemployee EXTENDS(DataController)



//=====================================================//
//=================== Violations ======================//
//=====================================================//


/*
 * 1 : Unauthorised Data Access
 * The Wearable Co employee browses the list of registered wearable customers and requests to access the complete
 *  record of the personal information of a customer, which is not allowed by the specified policy. CardioMon raises
 *  a data access exception.
 */

/*
 * 2 : Inadequate Data Retention / Deletion
 * The agreed accountability policy between CardioMon and the Wearable Co defines that the personal data collected from
 *  the customer’s device must be deleted if being older than 6 months. However, a backup of the CardioMon store is left.
 */

/*
 * 3 : Unauthorised Data Location
 * The Wearable Co has agreed with CardioMon that only data centres in Europe are used for storing the personal data of
 *  the customers. A sudden hardware failure in DataSpacer results in the CardioMon store being moved to a third country location.
 */

/*
 * 4 : Encryption vulnerability
 * The Map-on-Web uses encrypted communication with CardioMon to access the personal information of the customers
 *  collected from their devices in order to generate the statistics per geographical area. However, at a specific period
 *  of time this communication turns to be unencrypted.
 */

/*
 * 5 : Right to know vs. Need to know
 * The Wearable Co employee performs too many requests to access the list of wearable customers and get their profile
 *  data. Although being an authorized party, the employee invokes the relevant service too many times, indicating an
 *  abuse of its right, hence a (probable) security violation.
 */

/*
 * 6 : Service unavailability
 * The Wearable Customer requests the visualisation of statistical information, but the communication between
 *  CardioMon and Map-on-Web is broken.
 */


//=====================================================//
//========== Lawyer Readable Privacy Policy ===========//
//=====================================================//
/*
                          Privacy Policy of Wearable Company

The purpose of this form is to give you information about the Wearable Company and the processing
of your personal data through its Web-based application.
You should tick the box, only if you agree with the hereby presented conditions. By ticking the box “I
agree”, you provide your consent to the processing of your personal data as set out in this privacy
policy.

- About the Wearable Company :

Wearable Company is the responsible organization (“data controller’’) for the processing of personal
data through the Wearable Web Application. Web Application offers services through the cloud service
provider CardioMon.
Wearable company is a Greek company with registered offices in Athens.

- About the purposes for which your data will be processed :

Personal data submitted to the Wearable Company through its Web-based application will be used
only for the purposes specified in this policy or on the relevant pages of the Web-based application.
We will use your personal information to:
(a) administer our Wearable Service;
(b) personalise our Wearable Service for you;
(c) enable your use of the functionalities available on our Wearable Service for monitoring and
    updating your personal information collected from your wearable device or provided by you
    through this service;
(d) send you statistical information about the personal information collected from all of our customers
    through our Wearable Service;
(e) send you notifications and alerts on excessive wellbeing values, according to your profile, and any
    other violation on this policy or any security breach;
(f) personal information will be used to produce statistical information, which will be compiled by third
    parties;
(g) verify compliance with the terms and conditions governing the use of our Wearable Service;

Your data will not be used for any other purposes than those listed above. Your data will not be used
for direct marketing purposes.

Wearable company stores the data collected only for as long as it is necessary for the delivery of the
services offered through Wearable devices. Apart from where the law stipulates a specific period, we
retain your personal data for a period not exceeding the period required for the purposes for which it
was collected and processed. We therefore retain your personal data attached to your account until
the account deletion.

In compliance to our legal obligations with respect to the retention and deletion of personal
information, we set out specific conditions for our data retention policies and procedure.

Any personal information processed by the Wearable Service for the purposes stated in this policy
shall not be kept for longer than is necessary for those purposes.

We will usually delete any personal data applicable in this policy being more than 6 months old. We
will usually delete any personal data applicable in this policy, if your request deletion of your account to
our Wearable Service. Notwithstanding the other provisions of this Section, we will retain documents
(including electronic documents) containing personal data:
(a) to the extent that we are required to do so by law;
(b) if we believe that the documents may be relevant to any ongoing or prospective legal proceedings;
    and
(c) in order to establish, exercise or defend our legal rights (including providing information to others
    for the purposes of fraud prevention and reducing credit risk);

- About the data that will be processed :

Wearable Application processes data collected through the Wearable devices. Those data identify you
either directly or indirectly. Data that identifies you directly may be your first name or surname, your
date of birth, your e-mail address, your photo, etc. We may also collect data that identify you indirectly
such as your weight, your postcode, etc.

In particular, Wearable devices collect the following types of data:
(a) information about your wearable device and about the information for you recorded from this
    device per time unit (including the Sugar Level, the Blood Pressure and Heartbeat Rate);
(b) information that you provide to us when registering with our Wearable Service (including your
    Username and Password);
(c) information that you provide when completing your profile on our Wearable Service (including your
    Display Name, Gender, Age, Height, Weight and Country of origin);
(d) information that you provide to us when using the service on our Wearable Service, or that is
    generated in the course of the use of those services (including your daily wellbeing activities); and
(e) any other personal information that you choose to send to us (eg when filling in the optional field of
    the account form)

Note that Wearable devices use cookies. A cookie is a file containing an identifier (a string of letters
and numbers) that is sent by a web server to a web browser and is stored by the browser. The
identifier is then sent back to the server each time the browser requests a page from the server. If you
block cookies, you will not be able to use all the features on our Wearable Service.

- About your rights :

You can have access to your personal data. Wearable Company keep your data in an open format for
you to easily keep and access them.

You can amend your personal information at any time, add to, delete or update the personal data
produced by an active measurement on your part. This may be done directly in the application or on
request. Upon your request to delete your profile, all your personal information will be deleted within 6
months.

You can object to your data being processed by contacting our customer service department. You may
object for legitimate reasons to your data being processed. However, you should be aware that this
action might limit the scope of Wearable Application and devices.

To protect your privacy and the privacy of others, we may have to verify that you are who you are
before we can give you access to, or change, information about you.

- Access to personal information by third parties :

Wearable Application will be hosted by the servers of CardioMon, located in Athens. CardioMon is a
primary service provider, acting as a data processor. CardioMon will process information on behalf and
upon further instructions of the data controller, the Wearable Company.
CardioMon has access to your personal information for the purposes arising from the functionalities
available on our Wearable Service and as they are set out in this policy. CardioMon may disclose
further personal information to its subcontractor Map-on-Web, only when and if this is required for the
purposes set out in this policy.

Wearable company uses certain trusted third parties to help us provide, improve, protect, and promote
our Services. These third parties will access your information only to perform tasks on our behalf and
in compliance with this Privacy Policy. Our Wearable Service includes the visualisation of the statistical
information about the personal information collected from all of our customers provided by third party
applications.

We ensure that your personal data will not be disclosed to state institutions and Law Enforcement
authorities, except if required by law.

- Security measures :

Wearable company shall take the appropriate technical and organisational precautions to prevent the
loss, misuse or alteration of your personal information.
You are responsible for keeping the password you use for accessing our Wearable Service
confidential;

- Data transfers to international data centres :

Personal information that we collect from you may be stored and processed in and transferred
between any of the countries in which we operate within the EEA in order to enable us to use the
information in accordance with this policy.

Any other transfer of personal data outside of EEA is forbidden.

We may change our privacy policy to adapt to your needs, to the evolution of the legal framework or
when we develop our products and services. We shall inform you of any modification performed well in advance.
*/



//=====================================================//
//===================== Clauses =======================//
//=====================================================//

/*
    <!-- Rule for personal data accessing by Data Subjects (Clients of WearableCo)-->
    <!-- Rule1: All PII can be read, updated or deleted by Data Subject-->
*/

CLAUSE aal_rule_1(
    FORALL u:DataSubject FORALL b:Actor FORALL d:data
    IF(d.subject == u) THEN {
        PERMIT u.read[b](d)   AND
        PERMIT u.update[b](d) AND
        PERMIT u.delete[b](d)
    }
)

/*
    <!-- WearableCo's access control policy -->
    <!-- Rule 2: referring to access to personal data for WearableCo Employees -->
*/
CLAUSE aal_rule_2 (
    FORALL e:Employee FORALL d:data
    IF (@username(d) OR @displayName(d) OR @gender(d) OR @age(d) OR @country(d)) THEN
     {PERMIT e.read[cardioMon](d) PURPOSE (health) }
)

/*
    <!-- WearableCo's access control policy for Map-On-Web -->
    <!-- Rule 3: NON downstream usage -->
*/
CLAUSE aal_rule_3 (
    FORALL d:data
    IF( @age(d) OR @blood(d) OR @sugarLevel(d) OR @heartbeat(d) OR @country(d)) THEN
    {
        PERMIT mapOnWeb.read[cardioMon](d) AND
        MUST( mapOnWeb.delete[mapOnWeb](d) BEFORE "P0Y0M0DT0H2M0S")
    }
)

/*
    <!-- WearableCo's data handling policy -->
*/

//CLAUSE wearableCo_policy (
//    ref aal_rule_3
//)


/*
    <!-- Map-On-Web's data handling policy -->
*/
CLAUSE MapOnWeb_Policy (
    //  <!-- Wearable Co is accountable to their customers for how data are processed by Map-On-Web-->
    FORALL d:data FORALL a:Actor
    IF ( a.read[mapOnWeb](d) ) THEN
    {
         mapOnWeb.log[mapOnWeb]("Timestamp;Action;Purpose;Subject;Resource;")
    }
    AND
    // <!--Personal Data storage period of 6 months -->
    MUST( mapOnWeb.delete[mapOnWeb](d) BEFORE "6 months")

    AND

     // <!-- Notify Cardio Mon whenever access is denied-->
    IF (a.read[mapOnWeb](d) AND DENY a.read[mapOnWeb](d) ) THEN
    {
        MUST( mapOnWeb.notify[cardioMon]("Unauthorized Personal Data Access Attempt") )
    }

    AUDITING auditor.audit[mapOnWeb]()

    IF_VIOLATED_THEN
        // <!--Notification of Cardio Mon about security breach (policy violation) -->
        MUST(mapOnWeb.notify[cardioMon](""))
)


/*
CLAUSE km2 (
    PERMIT kim.read[cloudX]() or kim.read[cloudX]()
    AUDITING leslie.audit[cloudS]()
    IF_VIOLATED_THEN cloudX.delete[d]()
)


call validate2("'km2'")
*/
EXEC
"""
#print(self.clause("km2").to_natural())
#print(self.aalprog)
"""
